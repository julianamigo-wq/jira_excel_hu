name: 'Jira Webhook Processor'

# Este flujo de trabajo solo se ejecuta cuando es activado por una llamada API
# a través de un 'repository_dispatch', que es lo que hará el proxy de Flask.
on:
  repository_dispatch:
    types: [jira_attachment_event] # El tipo de evento que definiremos en Flask

# Permisos mínimos necesarios
permissions:
  contents: read

jobs:
  process_jira_webhook:
    runs-on: ubuntu-latest
    
    # El paso 'if' asegura que solo se ejecute si la carga útil (payload) 
    # enviada por el proxy de Flask contiene la clave del ticket.
    if: github.event.client_payload.issue_key != ''

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        # Instala todas las librerías necesarias: requests (Jira API), 
        # pypdf, python-docx (extracción), y openai (chat/IA).
        run: |
          pip install requests pypdf python-docx openai
          # NOTA: Si necesitas otros paquetes de tu proyecto (ej: para createxlsx o send_chat),
          # agrégalos aquí o usa un requirements.txt.

      - name: Run Jira Attachments Script
        # Ejecuta el script principal, pasando la clave del ticket como argumento.
        run: python get_issue_attachments.py ${{ github.event.client_payload.issue_key }}
        
        env:
          # --- Variables de Entorno de JIRA (existentes) ---
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }} 
          JIRA_API_USER: ${{ secrets.JIRA_API_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          
          # --- NUEVAS Variables de Correo Electrónico ---
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          
          # --- NUEVAS Variables de OPENAI / OPENROUTER ---
          # Si tu función send_chat usa OpenAI directamente, usa OPENAI_API_KEY.
          # Si usa OpenRouter, probablemente necesitas su API key. Asumo que tu librería 
          # interna utiliza esta clave.
          APIKEY_OPENROUTER: ${{ secrets.APIKEY_OPENROUTER }}
          
          # Añadimos la clave del ticket como ENV para usarla en el Asunto del email, si es necesario.
          JIRA_ISSUE_KEY: ${{ github.event.client_payload.issue_key }}
